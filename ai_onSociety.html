<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>여행 AI 에이전트 (Amadeus + Hotelbeds)</title>
<style>
body { font-family: Arial, sans-serif; margin: 20px; }
h1 { color: #2c3e50; }
.card { border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 15px; }
button { background: #3498db; color: #fff; border: none; padding: 10px; border-radius: 5px; cursor: pointer; margin-top: 10px; }
button:hover { background: #2980b9; }
textarea, input { width: 100%; margin: 10px 0; padding: 8px; }
.option-card { border: 1px solid #ccc; padding: 10px; margin: 5px 0; border-radius: 5px; cursor: pointer; transition: 0.2s; }
.option-card:hover { background: #f0f0f0; transform: scale(1.01); }
.results-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
@media (min-width: 600px) {
  .results-grid { grid-template-columns: 1fr 1fr; }
}
</style>
</head>
<body>

<h1>✈️ 여행 전문 AI 에이전트 (Amadeus + Hotelbeds)</h1>
<p>Amadeus(항공권) + Hotelbeds(호텔 가격 포함)</p>

<div class="card">
  <textarea id="user-request" placeholder="예: 인천에서 도쿄 2박3일 항공권과 호텔 찾아줘"></textarea>
  
  <label>출발일: <input type="date" id="depart-date"></label>
  <label>귀국일: <input type="date" id="return-date"></label>
  
  <button onclick="searchCandidates()">검색</button>
</div>

<div id="results"></div>
<div id="checkout"></div>

<script>
/* 🔑 Amadeus API 키 */
const AMADEUS_API_KEY = "oUyAg9AytYZam9Bsm4rv6LHdxtOTnrYw";
const AMADEUS_API_SECRET = "EnBuPF8ty7GLrRno";
let AMADEUS_ACCESS_TOKEN = "";

/* 🔑 Hotelbeds API 키 */
const HOTELBEDS_API_KEY = "c6b8e98642834eebf275c5d119ab18ec";
const HOTELBEDS_SECRET = "d167271487";  // 테스트용도 제공됨

// Amadeus 토큰 발급
async function getAmadeusToken() {
  const res = await fetch("https://test.api.amadeus.com/v1/security/oauth2/token", {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: `grant_type=client_credentials&client_id=${AMADEUS_API_KEY}&client_secret=${AMADEUS_API_SECRET}`
  });
  const data = await res.json();
  AMADEUS_ACCESS_TOKEN = data.access_token;
}

// 요청 파싱
function parseRequest(text) {
  const originMatch = text.match(/인천|서울|김포|부산|제주/);
  const destinationMatch = text.match(/도쿄|오사카|뉴욕|파리|런던/);
  const nightsMatch = text.match(/(\d)박/);
  const daysMatch = text.match(/(\d)일/);

  const departInput = document.getElementById("depart-date").value;
  const returnInput = document.getElementById("return-date").value;

  return {
    origin: originMatch ? "ICN" : "ICN",
    destination: destinationMatch ? "HND" : "HND",
    nights: nightsMatch ? parseInt(nightsMatch[1]) : 2,
    days: daysMatch ? parseInt(daysMatch[1]) : 3,
    departDate: departInput || "2025-10-01",
    returnDate: returnInput || "2025-10-03"
  };
}

// 항공권 API (Amadeus)
async function fetchFlights(query) {
  if (!AMADEUS_ACCESS_TOKEN) await getAmadeusToken();

  const url = `https://test.api.amadeus.com/v2/shopping/flight-offers?originLocationCode=${query.origin}&destinationLocationCode=${query.destination}&departureDate=${query.departDate}&returnDate=${query.returnDate}&adults=1&currencyCode=KRW&max=3`;

  const res = await fetch(url, {
    headers: { Authorization: `Bearer ${AMADEUS_ACCESS_TOKEN}` }
  });

  const data = await res.json();
  return data.data || [];
}

// 호텔 API (Hotelbeds Test)
async function fetchHotels(query) {
  const today = new Date(query.departDate);
  const checkout = new Date(query.returnDate);

  const checkinStr = today.toISOString().split("T")[0];
  const checkoutStr = checkout.toISOString().split("T")[0];

  const url = `https://api.test.hotelbeds.com/hotel-api/1.0/hotels?destinationCode=TYO&checkIn=${checkinStr}&checkOut=${checkoutStr}&occupancies=1`;

  const res = await fetch(url, {
    method: "GET",
    headers: {
      "Api-key": HOTELBEDS_API_KEY,
      "X-Signature": generateSignature(),
      "Accept": "application/json"
    }
  });

  const data = await res.json();
  return data.hotels ? data.hotels.hotels.slice(0, 3) : [];
}

// Hotelbeds Signature 생성
function generateSignature() {
  const ts = Math.floor(Date.now() / 1000);
  const cryptoStr = HOTELBEDS_API_KEY + HOTELBEDS_SECRET + ts;
  return CryptoJS.SHA256(cryptoStr).toString(CryptoJS.enc.Hex);
}

// 후보 검색
async function searchCandidates() {
  const text = document.getElementById("user-request").value;
  const query = parseRequest(text);

  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = `<p>검색 요청: ${query.origin} → ${query.destination}, ${query.nights}박 ${query.days}일 (${query.departDate} ~ ${query.returnDate})</p><h3>추천 옵션</h3>`;

  const flights = await fetchFlights(query);
  const hotels = await fetchHotels(query);

  const grid = document.createElement("div");
  grid.className = "results-grid";

  for (let i = 0; i < Math.min(flights.length, hotels.length); i++) {
    const flight = flights[i];
    const hotel = hotels[i];

    const div = document.createElement("div");
    div.className = "option-card";
    div.innerHTML = `
      <strong>[옵션 ${i+1}]</strong><br>
      ✈ 항공편: ${flight.itineraries[0].segments[0].carrierCode}<br>
      항공 가격: ₩${parseInt(flight.price.total).toLocaleString()}<br>
      🏨 호텔: ${hotel.name.content} | ₩${hotel.minRate.toLocaleString()} / 박
    `;
    div.onclick = () => selectOption(flight, hotel, query);
    grid.appendChild(div);
  }

  resultsDiv.appendChild(grid);
}

// 결제 화면
function selectOption(flight, hotel, query) {
  const checkoutDiv = document.getElementById("checkout");
  const totalCost = parseInt(flight.price.total) + hotel.minRate * query.nights;

  checkoutDiv.innerHTML = `
    <div class="card">
      <h3>🛒 결제 전 확인</h3>
      <p><strong>항공편:</strong> ${flight.itineraries[0].segments[0].carrierCode} | ₩${parseInt(flight.price.total).toLocaleString()}</p>
      <p><strong>호텔:</strong> ${hotel.name.content} | ₩${hotel.minRate.toLocaleString()} / 박</p>
      <p><strong>총 예상 비용:</strong> ₩${totalCost.toLocaleString()}</p>
      <button onclick="alert('모의 결제 완료! 실제 결제는 이루어지지 않습니다.')">모의 결제 진행</button>
    </div>
  `;
}
</script>

<!-- SHA256 생성을 위한 CryptoJS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

</body>
</html>
